/*! Copyright 2016 Ayogo Health Inc. */
export class MenuManager {
    static get open() {
        return this.isOpen;
    }
    static openMenu(btn, mnu, focus = false) {
        this.curButton = btn;
        this.curMenu = mnu;
        this.isOpen = true;
        this.curButton.setAttribute('aria-expanded', 'true');
        this.curButton.ownerDocument.documentElement.addEventListener('click', this.clickListener);
        this.curButton.addEventListener('blur', this.handleBlur);
        this.curButton.parentNode.insertBefore(this.curMenu, this.curButton.nextSibling);
        this.addMenuStyle();
        if (focus) {
            this.focusMenu();
        }
        this.curMenu.addEventListener('keydown', this.menuKeypressListener);
        this.curMenu.addEventListener('focusout', this.handleBlur);
        this.curMenu.addEventListener('click', this.menuClickListener);
    }
    static closeMenu() {
        if (!this.isOpen || !this.curButton || !this.curMenu) {
            return;
        }
        this.curButton.ownerDocument.documentElement.removeEventListener('click', this.clickListener);
        this.curButton.removeEventListener('blur', this.handleBlur);
        this.curButton.setAttribute('aria-expanded', 'false');
        this.curMenu.removeEventListener('keydown', this.menuKeypressListener);
        this.curMenu.removeEventListener('focusout', this.handleBlur);
        this.curMenu.removeEventListener('click', this.menuClickListener);
        let oldMenu = this.curMenu;
        let handler = () => {
            oldMenu.removeAttribute('style');
            oldMenu.removeEventListener('transitionend', handler);
            oldMenu.removeEventListener('webkittransitionend', handler);
        };
        if ('transitionDuration' in oldMenu.style) {
            oldMenu.style.transitionDuration = '192ms';
        }
        else {
            oldMenu.style.webkitTransitionDuration = '192ms';
        }
        if ('transform' in oldMenu.style) {
            oldMenu.style.transform = 'scaleY(0)';
        }
        else {
            oldMenu.style.webkitTransform = 'scaleY(0)';
        }
        oldMenu.addEventListener('transitionend', handler);
        oldMenu.addEventListener('webkittransitionend', handler);
        this.isOpen = false;
        this.curButton = null;
        this.curMenu = null;
        this.focusCount = null;
    }
    static toggleMenu(btn, mnu) {
        let openMnu = this.curMenu;
        if (this.isOpen && btn === this.curButton) {
            this.closeMenu();
        }
        if (openMnu !== mnu) {
            this.openMenu(btn, mnu);
        }
    }
    static focusMenu() {
        if (!this.curMenu) {
            return;
        }
        if (this.focusCount === null) {
            this.focusCount = 0;
        }
        let length = this.curMenu.children.length;
        if (this.focusCount < 0) {
            this.focusCount += length;
        }
        let mi = this.curMenu.children[this.focusCount % length];
        mi.focus();
    }
    static clickMenuItem() {
        if (!this.curMenu) {
            return;
        }
        let length = this.curMenu.children.length;
        let mi = this.curMenu.children[this.focusCount % length];
        if (!mi.hasAttribute('disabled')) {
            mi.click();
        }
    }
    static addMenuStyle() {
        if (!this.curMenu || !this.curButton) {
            return;
        }
        let menu = this.curMenu;
        let btn = this.curButton;
        menu.style.display = 'block';
        menu.style.position = 'fixed';
        menu.setAttribute('role', 'menu');
        menu.setAttribute('data-owner', 'button');
        menu.setAttribute('type', '');
        for (let i = 0; i < menu.children.length; i++) {
            menu.children[i].setAttribute('tabindex', '-1');
            menu.children[i].setAttribute('role', 'menuitem');
            menu.children[i].setAttribute('aria-disabled', menu.children[i].hasAttribute('disabled').toString());
        }
        requestAnimationFrame(() => {
            let btnSize = btn.getBoundingClientRect();
            let menuSize = menu.getBoundingClientRect();
            let wndHeight = window.innerHeight;
            if (btnSize.bottom + menuSize.height > wndHeight) {
                menu.style.bottom = btnSize.top + 'px';
            }
            else {
                menu.style.top = btnSize.bottom + 'px';
            }
            if (menuSize.width > btnSize.right) {
                menu.style.left = btnSize.left + 'px';
            }
            else {
                menu.style.left = (btnSize.right - menuSize.width) + 'px';
            }
            if ('transform' in menu.style) {
                menu.style.transform = 'scaleY(1)';
            }
            else {
                menu.style.webkitTransform = 'scaleY(1)';
            }
        });
    }
    static clickListener(e) {
        if (!MenuManager.curButton || !MenuManager.curMenu) {
            return;
        }
        if (MenuManager.curMenu.contains(e.target)) {
            return;
        }
        if (MenuManager.curButton.contains(e.target)) {
            return;
        }
        MenuManager.closeMenu();
    }
    static menuClickListener(e) {
        if (!MenuManager.curButton || !MenuManager.curMenu) {
            return;
        }
        let mi = e.target;
        if (!MenuManager.curMenu.contains(mi)) {
            return;
        }
        if (mi.hasAttribute('disabled')) {
            return;
        }
        MenuManager.closeMenu();
    }
    static handleBlur(e) {
        if (!MenuManager.curButton) {
            return;
        }
        let activeEl = e.relatedTarget;
        if (!activeEl) {
            return;
        }
        if (MenuManager.curButton === activeEl) {
            return;
        }
        if (MenuManager.curMenu && MenuManager.curMenu.contains(activeEl)) {
            return;
        }
        setTimeout(() => {
            if (MenuManager.isOpen) {
                MenuManager.closeMenu();
            }
        }, 0);
    }
    static menuKeypressListener(e) {
        if (!MenuManager.isOpen) {
            return;
        }
        if (e.keyCode === 27) {
            MenuManager.closeMenu();
        }
        if (e.keyCode === 38) {
            MenuManager.focusCount--;
            MenuManager.focusMenu();
        }
        if (e.keyCode === 40) {
            MenuManager.focusCount++;
            MenuManager.focusMenu();
        }
        if (e.keyCode === 32 || e.keyCode === 13) {
            MenuManager.clickMenuItem();
        }
    }
}
MenuManager.curMenu = null;
MenuManager.curButton = null;
MenuManager.isOpen = false;
MenuManager.focusCount = null;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHVDQUF1QztBQUV2QyxNQUFNO0lBT0YsTUFBTSxLQUFLLElBQUk7UUFDWCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUF1QixFQUFFLEdBQXFCLEVBQUUsUUFBa0IsS0FBSztRQUNuRixJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQztRQUNyQixJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUVuQixJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxlQUFlLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDM0YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBSXpELElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakYsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRXBCLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDUixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDckIsQ0FBQztRQUVELElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQ3BFLElBQUksQ0FBQyxPQUFPLENBQUMs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V0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzVCLENBQUM7UUFHRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkIsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3pCLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUM1QixDQUFDO1FBSUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNoQyxDQUFDO0lBQ0wsQ0FBQzs7QUEzUWMsbUJBQU8sR0FBb0MsSUFBSSxDQUFDO0FBQ2hELHFCQUFTLEdBQWtDLElBQUksQ0FBQztBQUNoRCxrQkFBTSxHQUFxQyxLQUFLLENBQUM7QUFDakQsc0JBQVUsR0FBaUMsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohIENvcHlyaWdodCAyMDE2IEF5b2dvIEhlYWx0aCBJbmMuICovXG5cbmV4cG9ydCBjbGFzcyBNZW51TWFuYWdlciB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgY3VyTWVudSA6IEhUTUxNZW51RWxlbWVudCB8IG51bGwgICAgICAgICA9IG51bGw7XG4gICAgcHJpdmF0ZSBzdGF0aWMgY3VyQnV0dG9uIDogSFRNTEJ1dHRvbkVsZW1lbnQgfCBudWxsICAgICA9IG51bGw7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaXNPcGVuIDogYm9vbGVhbiAgICAgICAgICAgICAgICAgICAgICAgICA9IGZhbHNlO1xuICAgIHByaXZhdGUgc3RhdGljIGZvY3VzQ291bnQgOiBudW1iZXIgfCBudWxsICAgICAgICAgICAgICAgPSBudWxsO1xuXG5cbiAgICBzdGF0aWMgZ2V0IG9wZW4oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzT3BlbjtcbiAgICB9XG5cbiAgICBzdGF0aWMgb3Blbk1lbnUoYnRuIDogSFRNTEJ1dHRvbkVsZW1lbnQsIG1udSA6IEhUTUxNZW51RWxlbWVudCwgZm9jdXMgOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICAgICAgdGhpcy5jdXJCdXR0b24gPSBidG47XG4gICAgICAgIHRoaXMuY3VyTWVudSA9IG1udTtcbiAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuY3VyQnV0dG9uLnNldEF0dHJpYnV0ZSgnYXJpYS1leHBhbmRlZCcsICd0cnVlJyk7XG4gICAgICAgIHRoaXMuY3VyQnV0dG9uLm93bmVyRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5jbGlja0xpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5jdXJCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsIHRoaXMuaGFuZGxlQmx1cik7XG5cbiAgICAgICAgLy8gQmVmb3JlIHdlIG9wZW4gdGhlIG1lbnUsIHdlIG5lZWQgdG8gbW92ZSBpdCBpbiB0aGUgRE9NIHNvIHRoYXQgaXNcbiAgICAgICAgLy8gaXMgZGlyZWN0bHkgYWZ0ZXIgdGhlIGJ1dHRvbiBlbGVtZW50IGZvciB0YWIgb3JkZXJpbmdcbiAgICAgICAgdGhpcy5jdXJCdXR0b24ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpcy5jdXJNZW51LCB0aGlzLmN1ckJ1dHRvbi5uZXh0U2libGluZyk7XG5cbiAgICAgICAgdGhpcy5hZGRNZW51U3R5bGUoKTtcblxuICAgICAgICBpZiAoZm9jdXMpIHtcbiAgICAgICAgICAgIHRoaXMuZm9jdXNNZW51KCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmN1ck1lbnUuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMubWVudUtleXByZXNzTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmN1ck1lbnUuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXNvdXQnLCB0aGlzLmhhbmRsZUJsdXIpO1xuICAgICAgICB0aGlzLmN1ck1lbnUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm1lbnVDbGlja0xpc3RlbmVyKTtcbiAgICB9XG5cblxuICAgIHN0YXRpYyBjbG9zZU1lbnUoKSB7XG4gICAgICAgIGlmICghdGhpcy5pc09wZW4gfHwgIXRoaXMuY3VyQnV0dG9uIHx8ICF0aGlzLmN1ck1lbnUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3VyQnV0dG9uLm93bmVyRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5jbGlja0xpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5jdXJCdXR0b24ucmVtb3ZlRXZlbnRMaXN0ZW5lcignYmx1cicsIHRoaXMuaGFuZGxlQmx1cik7XG4gICAgICAgIHRoaXMuY3VyQnV0dG9uLnNldEF0dHJpYnV0ZSgnYXJpYS1leHBhbmRlZCcsICdmYWxzZScpO1xuXG4gICAgICAgIHRoaXMuY3VyTWVudS5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5tZW51S2V5cHJlc3NMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuY3VyTWVudS5yZW1vdmVFdmVudExpc3RlbmVyKCdmb2N1c291dCcsIHRoaXMuaGFuZGxlQmx1cik7XG4gICAgICAgIHRoaXMuY3VyTWVudS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMubWVudUNsaWNrTGlzdGVuZXIpO1xuXG4gICAgICAgIGxldCBvbGRNZW51ID0gdGhpcy5jdXJNZW51O1xuICAgICAgICBsZXQgaGFuZGxlciA9ICgpID0+IHtcbiAgICAgICAgICAgIG9sZE1lbnUucmVtb3ZlQXR0cmlidXRlKCdzdHlsZScpO1xuICAgICAgICAgICAgb2xkTWVudS5yZW1vdmVFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgaGFuZGxlcik7XG4gICAgICAgICAgICBvbGRNZW51LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3dlYmtpdHRyYW5zaXRpb25lbmQnLCBoYW5kbGVyKTtcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoJ3RyYW5zaXRpb25EdXJhdGlvbicgaW4gb2xkTWVudS5zdHlsZSkge1xuICAgICAgICAgICAgb2xkTWVudS5zdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSAnMTkybXMnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb2xkTWVudS5zdHlsZS53ZWJraXRUcmFuc2l0aW9uRHVyYXRpb24gPSAnMTkybXMnO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCd0cmFuc2Zvcm0nIGluIG9sZE1lbnUuc3R5bGUpIHtcbiAgICAgICAgICAgIG9sZE1lbnUuc3R5bGUudHJhbnNmb3JtID0gJ3NjYWxlWSgwKSc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvbGRNZW51LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICdzY2FsZVkoMCknO1xuICAgICAgICB9XG5cbiAgICAgICAgb2xkTWVudS5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgaGFuZGxlcik7XG4gICAgICAgIG9sZE1lbnUuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0dHJhbnNpdGlvbmVuZCcsIGhhbmRsZXIpO1xuXG4gICAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY3VyQnV0dG9uID0gbnVsbDtcbiAgICAgICAgdGhpcy5jdXJNZW51ID0gbnVsbDtcbiAgICAgICAgdGhpcy5mb2N1c0NvdW50ID0gbnVsbDtcbiAgICB9XG5cblxuICAgIHN0YXRpYyB0b2dnbGVNZW51KGJ0biA6IEhUTUxCdXR0b25FbGVtZW50LCBtbnUgOiBIVE1MTWVudUVsZW1lbnQpIHtcbiAgICAgICAgbGV0IG9wZW5NbnUgPSB0aGlzLmN1ck1lbnU7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNPcGVuICYmIGJ0biA9PT0gdGhpcy5jdXJCdXR0b24pIHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VNZW51KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3Blbk1udSAhPT0gbW51KSB7XG4gICAgICAgICAgICB0aGlzLm9wZW5NZW51KGJ0biwgbW51KTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgc3RhdGljIGZvY3VzTWVudSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmN1ck1lbnUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmZvY3VzQ291bnQgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuZm9jdXNDb3VudCA9IDA7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbGVuZ3RoID0gdGhpcy5jdXJNZW51LmNoaWxkcmVuLmxlbmd0aDtcblxuICAgICAgICBpZiAodGhpcy5mb2N1c0NvdW50IDwgMCkge1xuICAgICAgICAgICAgdGhpcy5mb2N1c0NvdW50ICs9IGxlbmd0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBtaSA9IHRoaXMuY3VyTWVudS5jaGlsZHJlblt0aGlzLmZvY3VzQ291bnQgJSBsZW5ndGhdIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICBtaS5mb2N1cygpO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY2xpY2tNZW51SXRlbSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmN1ck1lbnUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBsZW5ndGggPSB0aGlzLmN1ck1lbnUuY2hpbGRyZW4ubGVuZ3RoO1xuICAgICAgICBsZXQgbWkgPSB0aGlzLmN1ck1lbnUuY2hpbGRyZW5bdGhpcy5mb2N1c0NvdW50ICUgbGVuZ3RoXSBhcyBIVE1MRWxlbWVudDtcblxuICAgICAgICBpZiAoIW1pLmhhc0F0dHJpYnV0ZSgnZGlzYWJsZWQnKSkge1xuICAgICAgICAgICAgbWkuY2xpY2soKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgYWRkTWVudVN0eWxlKCkge1xuICAgICAgICBpZiAoIXRoaXMuY3VyTWVudSB8fCAhdGhpcy5jdXJCdXR0b24pIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBtZW51ID0gdGhpcy5jdXJNZW51ITtcbiAgICAgICAgbGV0IGJ0biA9IHRoaXMuY3VyQnV0dG9uITtcblxuICAgICAgICAvLyBBZGQgdGhlIG1lbnUgdG8gdGhlIERPTSBmb3IgbWVhc3VyaW5nXG4gICAgICAgIG1lbnUuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgIG1lbnUuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnO1xuICAgICAgICBtZW51LnNldEF0dHJpYnV0ZSgncm9sZScsICdtZW51Jyk7XG4gICAgICAgIG1lbnUuc2V0QXR0cmlidXRlKCdkYXRhLW93bmVyJywgJ2J1dHRvbicpO1xuXG4gICAgICAgIC8vIFRyeSB0byB1bnNldCB0aGUgdHlwZSBzbyBGaXJlZm94IGNhbiBtYWtlIGl0IHZpc2libGUgOicoXG4gICAgICAgIG1lbnUuc2V0QXR0cmlidXRlKCd0eXBlJywgJycpO1xuXG4gICAgICAgIC8vIEVuc3VyZSB0aGUgY2hpbGRyZW4gYXJlIGZvY3VzYWJsZVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1lbnUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIG1lbnUuY2hpbGRyZW5baV0uc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsICctMScpO1xuICAgICAgICAgICAgbWVudS5jaGlsZHJlbltpXS5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCAnbWVudWl0ZW0nKTtcblxuICAgICAgICAgICAgbWVudS5jaGlsZHJlbltpXS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGlzYWJsZWQnLCBtZW51LmNoaWxkcmVuW2ldLmhhc0F0dHJpYnV0ZSgnZGlzYWJsZWQnKS50b1N0cmluZygpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgICAgICBsZXQgYnRuU2l6ZSA9IGJ0bi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgICAgIGxldCBtZW51U2l6ZSA9IG1lbnUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICBsZXQgd25kSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuXG4gICAgICAgICAgICBpZiAoYnRuU2l6ZS5ib3R0b20gKyBtZW51U2l6ZS5oZWlnaHQgPiB3bmRIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICBtZW51LnN0eWxlLmJvdHRvbSA9IGJ0blNpemUudG9wICsgJ3B4JztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbWVudS5zdHlsZS50b3AgPSBidG5TaXplLmJvdHRvbSArICdweCc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChtZW51U2l6ZS53aWR0aCA+IGJ0blNpemUucmlnaHQpIHtcbiAgICAgICAgICAgICAgICBtZW51LnN0eWxlLmxlZnQgPSBidG5TaXplLmxlZnQgKyAncHgnO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBtZW51LnN0eWxlLmxlZnQgPSAoYnRuU2l6ZS5yaWdodCAtIG1lbnVTaXplLndpZHRoKSArICdweCc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICgndHJhbnNmb3JtJyBpbiBtZW51LnN0eWxlKSB7XG4gICAgICAgICAgICAgICAgbWVudS5zdHlsZS50cmFuc2Zvcm0gPSAnc2NhbGVZKDEpJztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbWVudS5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAnc2NhbGVZKDEpJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIHN0YXRpYyBjbGlja0xpc3RlbmVyKGUgOiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIGlmICghTWVudU1hbmFnZXIuY3VyQnV0dG9uIHx8ICFNZW51TWFuYWdlci5jdXJNZW51KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoTWVudU1hbmFnZXIuY3VyTWVudS5jb250YWlucyhlLnRhcmdldCBhcyBOb2RlKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKE1lbnVNYW5hZ2VyLmN1ckJ1dHRvbi5jb250YWlucyhlLnRhcmdldCBhcyBOb2RlKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgTWVudU1hbmFnZXIuY2xvc2VNZW51KCk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIHN0YXRpYyBtZW51Q2xpY2tMaXN0ZW5lcihlIDogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAoIU1lbnVNYW5hZ2VyLmN1ckJ1dHRvbiB8fCAhTWVudU1hbmFnZXIuY3VyTWVudSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IG1pID0gZS50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICAgICAgaWYgKCFNZW51TWFuYWdlci5jdXJNZW51LmNvbnRhaW5zKG1pKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG1pLmhhc0F0dHJpYnV0ZSgnZGlzYWJsZWQnKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgTWVudU1hbmFnZXIuY2xvc2VNZW51KCk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIHN0YXRpYyBoYW5kbGVCbHVyKGUgOiBGb2N1c0V2ZW50KSB7XG4gICAgICAgIGlmICghTWVudU1hbmFnZXIuY3VyQnV0dG9uKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBFbGVtZW50IHRoYXQgZm9jdXMgaXMgbW92aW5nIHRvXG4gICAgICAgIGxldCBhY3RpdmVFbCA9IGUucmVsYXRlZFRhcmdldCBhcyBIVE1MRWxlbWVudCB8IG51bGw7XG5cbiAgICAgICAgaWYgKCFhY3RpdmVFbCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKE1lbnVNYW5hZ2VyLmN1ckJ1dHRvbiA9PT0gYWN0aXZlRWwpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChNZW51TWFuYWdlci5jdXJNZW51ICYmIE1lbnVNYW5hZ2VyLmN1ck1lbnUuY29udGFpbnMoYWN0aXZlRWwpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBXYWl0IHVudGlsIGFmdGVyIGZvY3VzIGhhcyBtb3ZlZCBiZWZvcmUgY2xvc2luZyB0aGUgbWVudVxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGlmIChNZW51TWFuYWdlci5pc09wZW4pIHtcbiAgICAgICAgICAgICAgICBNZW51TWFuYWdlci5jbG9zZU1lbnUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgMCk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIHN0YXRpYyBtZW51S2V5cHJlc3NMaXN0ZW5lcihlIDogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICBpZiAoIU1lbnVNYW5hZ2VyLmlzT3Blbikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRXNjYXBlXG4gICAgICAgIGlmIChlLmtleUNvZGUgPT09IDI3KSB7XG4gICAgICAgICAgICBNZW51TWFuYWdlci5jbG9zZU1lbnUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVwIEFycm93XG4gICAgICAgIGlmIChlLmtleUNvZGUgPT09IDM4KSB7XG4gICAgICAgICAgICBNZW51TWFuYWdlci5mb2N1c0NvdW50LS07XG4gICAgICAgICAgICBNZW51TWFuYWdlci5mb2N1c01lbnUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERvd24gQXJyb3dcbiAgICAgICAgaWYgKGUua2V5Q29kZSA9PT0gNDApIHtcbiAgICAgICAgICAgIE1lbnVNYW5hZ2VyLmZvY3VzQ291bnQrKztcbiAgICAgICAgICAgIE1lbnVNYW5hZ2VyLmZvY3VzTWVudSgpO1xuICAgICAgICB9XG5cblxuICAgICAgICAvLyBFbnRlciBhbmQgU3BhY2ViYXJcbiAgICAgICAgaWYgKGUua2V5Q29kZSA9PT0gMzIgfHwgZS5rZXlDb2RlID09PSAxMykge1xuICAgICAgICAgICAgTWVudU1hbmFnZXIuY2xpY2tNZW51SXRlbSgpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19