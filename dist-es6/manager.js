/*! Copyright 2016 Ayogo Health Inc. */
export class MenuManager {
    static get open() {
        return this.isOpen;
    }
    static openMenu(btn, mnu, focus = false) {
        if (this.transitionEndHandler !== null) {
            this.transitionEndHandler();
        }
        this.curButton = btn;
        this.curMenu = mnu;
        this.isOpen = true;
        this.curButton.setAttribute('aria-expanded', 'true');
        this.curButton.ownerDocument.documentElement.addEventListener('click', this.clickListener);
        this.curButton.addEventListener('blur', this.handleBlur);
        this.curButton.parentNode.insertBefore(this.curMenu, this.curButton.nextSibling);
        this.addMenuStyle();
        if (focus) {
            this.focusMenu();
        }
        this.curMenu.addEventListener('keydown', this.menuKeypressListener);
        this.curMenu.addEventListener('focusout', this.handleBlur);
        this.curMenu.addEventListener('click', this.menuClickListener);
    }
    static closeMenu() {
        if (!this.isOpen || !this.curButton || !this.curMenu) {
            return;
        }
        this.curButton.ownerDocument.documentElement.removeEventListener('click', this.clickListener);
        this.curButton.removeEventListener('blur', this.handleBlur);
        this.curButton.setAttribute('aria-expanded', 'false');
        this.curMenu.removeEventListener('keydown', this.menuKeypressListener);
        this.curMenu.removeEventListener('focusout', this.handleBlur);
        this.curMenu.removeEventListener('click', this.menuClickListener);
        let oldMenu = this.curMenu;
        this.transitionEndHandler = () => {
            oldMenu.removeAttribute('style');
            oldMenu.removeEventListener('transitionend', this.transitionEndHandler);
            oldMenu.removeEventListener('webkittransitionend', this.transitionEndHandler);
            this.transitionEndHandler = null;
        };
        if ('transitionDuration' in oldMenu.style) {
            oldMenu.style.transitionDuration = '192ms';
        }
        else {
            oldMenu.style.webkitTransitionDuration = '192ms';
        }
        if ('transform' in oldMenu.style) {
            oldMenu.style.transform = 'scaleY(0)';
        }
        else {
            oldMenu.style.webkitTransform = 'scaleY(0)';
        }
        oldMenu.addEventListener('transitionend', this.transitionEndHandler);
        oldMenu.addEventListener('webkittransitionend', this.transitionEndHandler);
        this.isOpen = false;
        this.curButton = null;
        this.curMenu = null;
        this.focusCount = null;
    }
    static toggleMenu(btn, mnu) {
        let openMnu = this.curMenu;
        if (this.isOpen && btn === this.curButton) {
            this.closeMenu();
        }
        if (openMnu !== mnu) {
            this.openMenu(btn, mnu);
        }
    }
    static focusMenu() {
        if (!this.curMenu) {
            return;
        }
        if (this.focusCount === null) {
            this.focusCount = 0;
        }
        let length = this.curMenu.children.length;
        if (this.focusCount < 0) {
            this.focusCount += length;
        }
        let mi = this.curMenu.children[this.focusCount % length];
        mi.focus();
    }
    static clickMenuItem() {
        if (!this.curMenu) {
            return;
        }
        let length = this.curMenu.children.length;
        let mi = this.curMenu.children[this.focusCount % length];
        if (!mi.hasAttribute('disabled')) {
            mi.click();
        }
    }
    static addMenuStyle() {
        if (!this.curMenu || !this.curButton) {
            return;
        }
        let menu = this.curMenu;
        let btn = this.curButton;
        menu.style.display = 'block';
        menu.style.position = 'fixed';
        menu.setAttribute('role', 'menu');
        menu.setAttribute('data-owner', 'button');
        menu.setAttribute('type', '');
        for (let i = 0; i < menu.children.length; i++) {
            menu.children[i].setAttribute('tabindex', '-1');
            menu.children[i].setAttribute('role', 'menuitem');
            menu.children[i].setAttribute('aria-disabled', menu.children[i].hasAttribute('disabled').toString());
        }
        requestAnimationFrame(() => {
            let btnSize = btn.getBoundingClientRect();
            let menuSize = menu.getBoundingClientRect();
            let wndHeight = window.innerHeight;
            if (btnSize.bottom + menuSize.height > wndHeight) {
                menu.style.bottom = btnSize.top + 'px';
            }
            else {
                menu.style.top = btnSize.bottom + 'px';
            }
            if (menuSize.width > btnSize.right) {
                menu.style.left = btnSize.left + 'px';
            }
            else {
                menu.style.left = (btnSize.right - menuSize.width) + 'px';
            }
            if ('transform' in menu.style) {
                menu.style.transform = 'scaleY(1)';
            }
            else {
                menu.style.webkitTransform = 'scaleY(1)';
            }
        });
    }
    static clickListener(e) {
        if (!MenuManager.curButton || !MenuManager.curMenu) {
            return;
        }
        if (MenuManager.curMenu.contains(e.target)) {
            return;
        }
        if (MenuManager.curButton.contains(e.target)) {
            return;
        }
        MenuManager.closeMenu();
    }
    static menuClickListener(e) {
        if (!MenuManager.curButton || !MenuManager.curMenu) {
            return;
        }
        let mi = e.target;
        if (!MenuManager.curMenu.contains(mi)) {
            return;
        }
        if (mi.hasAttribute('disabled')) {
            return;
        }
        MenuManager.closeMenu();
    }
    static handleBlur(e) {
        if (!MenuManager.curButton) {
            return;
        }
        let activeEl = e.relatedTarget;
        if (!activeEl) {
            return;
        }
        if (MenuManager.curButton === activeEl) {
            return;
        }
        if (MenuManager.curMenu && MenuManager.curMenu.contains(activeEl)) {
            return;
        }
        setTimeout(() => {
            if (MenuManager.isOpen) {
                MenuManager.closeMenu();
            }
        }, 0);
    }
    static menuKeypressListener(e) {
        if (!MenuManager.isOpen) {
            return;
        }
        if (e.keyCode === 27) {
            MenuManager.closeMenu();
        }
        if (e.keyCode === 38) {
            MenuManager.focusCount--;
            MenuManager.focusMenu();
        }
        if (e.keyCode === 40) {
            MenuManager.focusCount++;
            MenuManager.focusMenu();
        }
        if (e.keyCode === 32 || e.keyCode === 13) {
            MenuManager.clickMenuItem();
        }
    }
}
MenuManager.curMenu = null;
MenuManager.curButton = null;
MenuManager.isOpen = false;
MenuManager.focusCount = null;
MenuManager.transitionEndHandler = null;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHVDQUF1QztBQUV2QyxNQUFNO0lBUUYsTUFBTSxLQUFLLElBQUk7UUFDWCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUF1QixFQUFFLEdBQXFCLEVBQUUsUUFBa0IsS0FBSztRQUNuRixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsb0JBQXFCLEVBQUUsQ0FBQztRQUNqQyxDQUFDO1FBRUQsSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFFbkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzNGLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUl6RCxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWpGLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUVwQixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1IsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3JC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O1FBR0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ25CLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUM1QixDQUFDO1FBR0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ25CLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN6QixXQUFXLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDNUIsQ0FBQztRQUdELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNuQixXQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDekIsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzVCLENBQUM7UUFJRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDdkMsV0FBVyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ2hDLENBQUM7SUFDTCxDQUFDOztBQWpSYyxtQkFBTyxHQUF3QyxJQUFJLENBQUM7QUFDcEQscUJBQVMsR0FBc0MsSUFBSSxDQUFDO0FBQ3BELGtCQUFNLEdBQXlDLEtBQUssQ0FBQztBQUNyRCxzQkFBVSxHQUFxQyxJQUFJLENBQUM7QUFDcEQsZ0NBQW9CLEdBQTJCLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qISBDb3B5cmlnaHQgMjAxNiBBeW9nbyBIZWFsdGggSW5jLiAqL1xuXG5leHBvcnQgY2xhc3MgTWVudU1hbmFnZXIge1xuICAgIHByaXZhdGUgc3RhdGljIGN1ck1lbnUgOiBIVE1MTWVudUVsZW1lbnQgfCBudWxsICAgICAgICAgICAgID0gbnVsbDtcbiAgICBwcml2YXRlIHN0YXRpYyBjdXJCdXR0b24gOiBIVE1MQnV0dG9uRWxlbWVudCB8IG51bGwgICAgICAgICA9IG51bGw7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaXNPcGVuIDogYm9vbGVhbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBmYWxzZTtcbiAgICBwcml2YXRlIHN0YXRpYyBmb2N1c0NvdW50IDogbnVtYmVyIHwgbnVsbCAgICAgICAgICAgICAgICAgICA9IG51bGw7XG4gICAgcHJpdmF0ZSBzdGF0aWMgdHJhbnNpdGlvbkVuZEhhbmRsZXIgOiAoKCkgPT4gdm9pZCkgfCBudWxsICAgPSBudWxsO1xuXG5cbiAgICBzdGF0aWMgZ2V0IG9wZW4oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzT3BlbjtcbiAgICB9XG5cbiAgICBzdGF0aWMgb3Blbk1lbnUoYnRuIDogSFRNTEJ1dHRvbkVsZW1lbnQsIG1udSA6IEhUTUxNZW51RWxlbWVudCwgZm9jdXMgOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICAgICAgaWYgKHRoaXMudHJhbnNpdGlvbkVuZEhhbmRsZXIgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZEhhbmRsZXIhKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmN1ckJ1dHRvbiA9IGJ0bjtcbiAgICAgICAgdGhpcy5jdXJNZW51ID0gbW51O1xuICAgICAgICB0aGlzLmlzT3BlbiA9IHRydWU7XG5cbiAgICAgICAgdGhpcy5jdXJCdXR0b24uc2V0QXR0cmlidXRlKCdhcmlhLWV4cGFuZGVkJywgJ3RydWUnKTtcbiAgICAgICAgdGhpcy5jdXJCdXR0b24ub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmNsaWNrTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmN1ckJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgdGhpcy5oYW5kbGVCbHVyKTtcblxuICAgICAgICAvLyBCZWZvcmUgd2Ugb3BlbiB0aGUgbWVudSwgd2UgbmVlZCB0byBtb3ZlIGl0IGluIHRoZSBET00gc28gdGhhdCBpc1xuICAgICAgICAvLyBpcyBkaXJlY3RseSBhZnRlciB0aGUgYnV0dG9uIGVsZW1lbnQgZm9yIHRhYiBvcmRlcmluZ1xuICAgICAgICB0aGlzLmN1ckJ1dHRvbi5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzLmN1ck1lbnUsIHRoaXMuY3VyQnV0dG9uLm5leHRTaWJsaW5nKTtcblxuICAgICAgICB0aGlzLmFkZE1lbnVTdHlsZSgpO1xuXG4gICAgICAgIGlmIChmb2N1cykge1xuICAgICAgICAgICAgdGhpcy5mb2N1c01lbnUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3VyTWVudS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5tZW51S2V5cHJlc3NMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuY3VyTWVudS5hZGRFdmVudExpc3RlbmVyKCdmb2N1c291dCcsIHRoaXMuaGFuZGxlQmx1cik7XG4gICAgICAgIHRoaXMuY3VyTWVudS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMubWVudUNsaWNrTGlzdGVuZXIpO1xuICAgIH1cblxuXG4gICAgc3RhdGljIGNsb3NlTWVudSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzT3BlbiB8fCAhdGhpcy5jdXJCdXR0b24gfHwgIXRoaXMuY3VyTWVudSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jdXJCdXR0b24ub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmNsaWNrTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmN1ckJ1dHRvbi5yZW1vdmVFdmVudExpc3RlbmVyKCdibHVyJywgdGhpcy5oYW5kbGVCbHVyKTtcbiAgICAgICAgdGhpcy5jdXJCdXR0b24uc2V0QXR0cmlidXRlKCdhcmlhLWV4cGFuZGVkJywgJ2ZhbHNlJyk7XG5cbiAgICAgICAgdGhpcy5jdXJNZW51LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLm1lbnVLZXlwcmVzc0xpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5jdXJNZW51LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2ZvY3Vzb3V0JywgdGhpcy5oYW5kbGVCbHVyKTtcbiAgICAgICAgdGhpcy5jdXJNZW51LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5tZW51Q2xpY2tMaXN0ZW5lcik7XG5cbiAgICAgICAgbGV0IG9sZE1lbnUgPSB0aGlzLmN1ck1lbnU7XG4gICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZEhhbmRsZXIgPSAoKSA9PiB7XG4gICAgICAgICAgICBvbGRNZW51LnJlbW92ZUF0dHJpYnV0ZSgnc3R5bGUnKTtcbiAgICAgICAgICAgIG9sZE1lbnUucmVtb3ZlRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIHRoaXMudHJhbnNpdGlvbkVuZEhhbmRsZXIhKTtcbiAgICAgICAgICAgIG9sZE1lbnUucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0dHJhbnNpdGlvbmVuZCcsIHRoaXMudHJhbnNpdGlvbkVuZEhhbmRsZXIhKTtcbiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvbkVuZEhhbmRsZXIgPSBudWxsO1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmICgndHJhbnNpdGlvbkR1cmF0aW9uJyBpbiBvbGRNZW51LnN0eWxlKSB7XG4gICAgICAgICAgICBvbGRNZW51LnN0eWxlLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcxOTJtcyc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvbGRNZW51LnN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9ICcxOTJtcyc7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoJ3RyYW5zZm9ybScgaW4gb2xkTWVudS5zdHlsZSkge1xuICAgICAgICAgICAgb2xkTWVudS5zdHlsZS50cmFuc2Zvcm0gPSAnc2NhbGVZKDApJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9sZE1lbnUuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3NjYWxlWSgwKSc7XG4gICAgICAgIH1cblxuICAgICAgICBvbGRNZW51LmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCB0aGlzLnRyYW5zaXRpb25FbmRIYW5kbGVyISk7XG4gICAgICAgIG9sZE1lbnUuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0dHJhbnNpdGlvbmVuZCcsIHRoaXMudHJhbnNpdGlvbkVuZEhhbmRsZXIhKTtcblxuICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLmN1ckJ1dHRvbiA9IG51bGw7XG4gICAgICAgIHRoaXMuY3VyTWVudSA9IG51bGw7XG4gICAgICAgIHRoaXMuZm9jdXNDb3VudCA9IG51bGw7XG4gICAgfVxuXG5cbiAgICBzdGF0aWMgdG9nZ2xlTWVudShidG4gOiBIVE1MQnV0dG9uRWxlbWVudCwgbW51IDogSFRNTE1lbnVFbGVtZW50KSB7XG4gICAgICAgIGxldCBvcGVuTW51ID0gdGhpcy5jdXJNZW51O1xuXG4gICAgICAgIGlmICh0aGlzLmlzT3BlbiAmJiBidG4gPT09IHRoaXMuY3VyQnV0dG9uKSB7XG4gICAgICAgICAgICB0aGlzLmNsb3NlTWVudSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wZW5NbnUgIT09IG1udSkge1xuICAgICAgICAgICAgdGhpcy5vcGVuTWVudShidG4sIG1udSk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHN0YXRpYyBmb2N1c01lbnUoKSB7XG4gICAgICAgIGlmICghdGhpcy5jdXJNZW51KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5mb2N1c0NvdW50ID09PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLmZvY3VzQ291bnQgPSAwO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGxlbmd0aCA9IHRoaXMuY3VyTWVudS5jaGlsZHJlbi5sZW5ndGg7XG5cbiAgICAgICAgaWYgKHRoaXMuZm9jdXNDb3VudCA8IDApIHtcbiAgICAgICAgICAgIHRoaXMuZm9jdXNDb3VudCArPSBsZW5ndGg7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbWkgPSB0aGlzLmN1ck1lbnUuY2hpbGRyZW5bdGhpcy5mb2N1c0NvdW50ICUgbGVuZ3RoXSBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgbWkuZm9jdXMoKTtcbiAgICB9XG5cblxuICAgIHByaXZhdGUgc3RhdGljIGNsaWNrTWVudUl0ZW0oKSB7XG4gICAgICAgIGlmICghdGhpcy5jdXJNZW51KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbGVuZ3RoID0gdGhpcy5jdXJNZW51LmNoaWxkcmVuLmxlbmd0aDtcbiAgICAgICAgbGV0IG1pID0gdGhpcy5jdXJNZW51LmNoaWxkcmVuW3RoaXMuZm9jdXNDb3VudCAlIGxlbmd0aF0gYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICAgICAgaWYgKCFtaS5oYXNBdHRyaWJ1dGUoJ2Rpc2FibGVkJykpIHtcbiAgICAgICAgICAgIG1pLmNsaWNrKCk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHByaXZhdGUgc3RhdGljIGFkZE1lbnVTdHlsZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmN1ck1lbnUgfHwgIXRoaXMuY3VyQnV0dG9uKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbWVudSA9IHRoaXMuY3VyTWVudSE7XG4gICAgICAgIGxldCBidG4gPSB0aGlzLmN1ckJ1dHRvbiE7XG5cbiAgICAgICAgLy8gQWRkIHRoZSBtZW51IHRvIHRoZSBET00gZm9yIG1lYXN1cmluZ1xuICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICBtZW51LnN0eWxlLnBvc2l0aW9uID0gJ2ZpeGVkJztcbiAgICAgICAgbWVudS5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCAnbWVudScpO1xuICAgICAgICBtZW51LnNldEF0dHJpYnV0ZSgnZGF0YS1vd25lcicsICdidXR0b24nKTtcblxuICAgICAgICAvLyBUcnkgdG8gdW5zZXQgdGhlIHR5cGUgc28gRmlyZWZveCBjYW4gbWFrZSBpdCB2aXNpYmxlIDonKFxuICAgICAgICBtZW51LnNldEF0dHJpYnV0ZSgndHlwZScsICcnKTtcblxuICAgICAgICAvLyBFbnN1cmUgdGhlIGNoaWxkcmVuIGFyZSBmb2N1c2FibGVcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtZW51LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBtZW51LmNoaWxkcmVuW2ldLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAnLTEnKTtcbiAgICAgICAgICAgIG1lbnUuY2hpbGRyZW5baV0uc2V0QXR0cmlidXRlKCdyb2xlJywgJ21lbnVpdGVtJyk7XG5cbiAgICAgICAgICAgIG1lbnUuY2hpbGRyZW5baV0uc2V0QXR0cmlidXRlKCdhcmlhLWRpc2FibGVkJywgbWVudS5jaGlsZHJlbltpXS5oYXNBdHRyaWJ1dGUoJ2Rpc2FibGVkJykudG9TdHJpbmcoKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgICAgbGV0IGJ0blNpemUgPSBidG4uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICBsZXQgbWVudVNpemUgPSBtZW51LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICAgICAgbGV0IHduZEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcblxuICAgICAgICAgICAgaWYgKGJ0blNpemUuYm90dG9tICsgbWVudVNpemUuaGVpZ2h0ID4gd25kSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgbWVudS5zdHlsZS5ib3R0b20gPSBidG5TaXplLnRvcCArICdweCc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG1lbnUuc3R5bGUudG9wID0gYnRuU2l6ZS5ib3R0b20gKyAncHgnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobWVudVNpemUud2lkdGggPiBidG5TaXplLnJpZ2h0KSB7XG4gICAgICAgICAgICAgICAgbWVudS5zdHlsZS5sZWZ0ID0gYnRuU2l6ZS5sZWZ0ICsgJ3B4JztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbWVudS5zdHlsZS5sZWZ0ID0gKGJ0blNpemUucmlnaHQgLSBtZW51U2l6ZS53aWR0aCkgKyAncHgnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoJ3RyYW5zZm9ybScgaW4gbWVudS5zdHlsZSkge1xuICAgICAgICAgICAgICAgIG1lbnUuc3R5bGUudHJhbnNmb3JtID0gJ3NjYWxlWSgxKSc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG1lbnUuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3NjYWxlWSgxKSc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY2xpY2tMaXN0ZW5lcihlIDogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAoIU1lbnVNYW5hZ2VyLmN1ckJ1dHRvbiB8fCAhTWVudU1hbmFnZXIuY3VyTWVudSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKE1lbnVNYW5hZ2VyLmN1ck1lbnUuY29udGFpbnMoZS50YXJnZXQgYXMgTm9kZSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChNZW51TWFuYWdlci5jdXJCdXR0b24uY29udGFpbnMoZS50YXJnZXQgYXMgTm9kZSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIE1lbnVNYW5hZ2VyLmNsb3NlTWVudSgpO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgbWVudUNsaWNrTGlzdGVuZXIoZSA6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgaWYgKCFNZW51TWFuYWdlci5jdXJCdXR0b24gfHwgIU1lbnVNYW5hZ2VyLmN1ck1lbnUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBtaSA9IGUudGFyZ2V0IGFzIEhUTUxFbGVtZW50O1xuXG4gICAgICAgIGlmICghTWVudU1hbmFnZXIuY3VyTWVudS5jb250YWlucyhtaSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtaS5oYXNBdHRyaWJ1dGUoJ2Rpc2FibGVkJykpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIE1lbnVNYW5hZ2VyLmNsb3NlTWVudSgpO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgaGFuZGxlQmx1cihlIDogRm9jdXNFdmVudCkge1xuICAgICAgICBpZiAoIU1lbnVNYW5hZ2VyLmN1ckJ1dHRvbikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRWxlbWVudCB0aGF0IGZvY3VzIGlzIG1vdmluZyB0b1xuICAgICAgICBsZXQgYWN0aXZlRWwgPSBlLnJlbGF0ZWRUYXJnZXQgYXMgSFRNTEVsZW1lbnQgfCBudWxsO1xuXG4gICAgICAgIGlmICghYWN0aXZlRWwpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChNZW51TWFuYWdlci5jdXJCdXR0b24gPT09IGFjdGl2ZUVsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoTWVudU1hbmFnZXIuY3VyTWVudSAmJiBNZW51TWFuYWdlci5jdXJNZW51LmNvbnRhaW5zKGFjdGl2ZUVsKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gV2FpdCB1bnRpbCBhZnRlciBmb2N1cyBoYXMgbW92ZWQgYmVmb3JlIGNsb3NpbmcgdGhlIG1lbnVcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAoTWVudU1hbmFnZXIuaXNPcGVuKSB7XG4gICAgICAgICAgICAgICAgTWVudU1hbmFnZXIuY2xvc2VNZW51KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDApO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgbWVudUtleXByZXNzTGlzdGVuZXIoZSA6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgaWYgKCFNZW51TWFuYWdlci5pc09wZW4pIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEVzY2FwZVxuICAgICAgICBpZiAoZS5rZXlDb2RlID09PSAyNykge1xuICAgICAgICAgICAgTWVudU1hbmFnZXIuY2xvc2VNZW51KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBVcCBBcnJvd1xuICAgICAgICBpZiAoZS5rZXlDb2RlID09PSAzOCkge1xuICAgICAgICAgICAgTWVudU1hbmFnZXIuZm9jdXNDb3VudC0tO1xuICAgICAgICAgICAgTWVudU1hbmFnZXIuZm9jdXNNZW51KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBEb3duIEFycm93XG4gICAgICAgIGlmIChlLmtleUNvZGUgPT09IDQwKSB7XG4gICAgICAgICAgICBNZW51TWFuYWdlci5mb2N1c0NvdW50Kys7XG4gICAgICAgICAgICBNZW51TWFuYWdlci5mb2N1c01lbnUoKTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgLy8gRW50ZXIgYW5kIFNwYWNlYmFyXG4gICAgICAgIGlmIChlLmtleUNvZGUgPT09IDMyIHx8IGUua2V5Q29kZSA9PT0gMTMpIHtcbiAgICAgICAgICAgIE1lbnVNYW5hZ2VyLmNsaWNrTWVudUl0ZW0oKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==